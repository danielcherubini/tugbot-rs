# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

tugbot-rs is a Discord bot written in Rust using the Serenity framework. It provides various features including a "gulag" system (temporary role punishment), social media link rewrites, and server management.

## Development Commands

### Building and Running
```bash
cargo build                 # Build the project
cargo run                   # Run the bot locally
cargo test                  # Run all tests
cargo test <test_name>      # Run a specific test
cargo check                 # Quick compile check without generating binary
```

### Database Management
```bash
# Start PostgreSQL (required for development)
docker-compose up -d

# Run Diesel migrations
diesel migration run
diesel migration revert     # Revert last migration
diesel migration redo       # Revert and re-run last migration
```

### Environment Setup
Required environment variables (create a `.env` file):
- `DISCORD_TOKEN` - Discord bot token
- `APPLICATION_ID` - Discord application ID
- `DATABASE_URL` - PostgreSQL connection string (e.g., `postgres://tugbot:tugbot@localhost/tugbot`)

### Database Access via MCP (Claude Code)

For direct database access in Claude Code, set up an MCP server:

```bash
# Extract DATABASE_URL from .env
source .env

# Add MCP server for database access
claude mcp add --transport stdio tugbot-db -- npx -y @bytebase/dbhub --dsn "$DATABASE_URL"

# Verify connection
claude mcp list
```

This enables Claude Code to directly query and inspect the database using natural language.

## Architecture

### Core Components

1. **Handler System** (`src/handlers/mod.rs`)
   - Main event handler implements Serenity's `EventHandler` trait
   - Dispatches events to feature-specific handlers
   - Message handlers run on every message (Twitter, TikTok, Bsky, Instagram link rewrites)
   - Interaction handlers process slash commands
   - Reaction handlers manage gulag voting

2. **Gulag System** (`src/handlers/gulag/`)
   - Multi-module feature for temporary role-based punishment
   - Uses background async tasks (`run_gulag_check`, `run_gulag_vote_check`) that poll the database every second
   - Manages vote tracking via reactions and slash commands
   - Automatically releases users when time expires
   - Handles edge cases like user rejoining while in gulag

3. **Database Layer** (`src/db/`)
   - Uses Diesel ORM with PostgreSQL
   - Schema defined in `src/db/schema.rs` (auto-generated by Diesel)
   - Models in `src/db/models.rs`
   - Database functions in `src/db/mod.rs`
   - Migrations in `migrations/` directory

4. **Feature Flags** (`src/features/mod.rs`)
   - Database-backed feature toggles
   - Check with `Features::is_enabled("feature_name")`
   - Update with `Features::update("feature_name", bool)`

5. **Configuration** (`src/tugbot/config.rs`)
   - Loads environment variables using dotenv
   - Configures Discord gateway intents
   - Bot token and application ID

### Handler Pattern

Handlers follow a consistent pattern:
- Struct with no fields (e.g., `pub struct Twitter;`)
- `handler()` method for processing events (messages, reactions, etc.)
- For slash commands: `setup_command()` and `setup_interaction()` methods
- Feature flag checks via `Features::is_enabled()`

### Slash Command Registration

Commands are registered per-guild in the `ready()` event handler (`src/handlers/mod.rs:143-173`). When adding new commands:
1. Create handler in appropriate module
2. Implement `setup_command()` and `setup_interaction()`
3. Add to command registration in `ready()` event
4. Add to interaction dispatch in `interaction_create()`

### Background Tasks

The gulag system spawns two background tasks in `ready()`:
- `run_gulag_check()` - Releases users when their sentence expires
- `run_gulag_vote_check()` - Processes votes that reach threshold (5 votes)

Both use `tokio::spawn()` with infinite loops and 1-second sleep intervals.

## Deployment

### Initial Setup

The bot is deployed to an LXC container. Initial setup:

```bash
# Clone repository
git clone git@github.com:danielcherubini/tugbot-rs.git /opt/tugbot

# Run installation script (as root)
cd /opt/tugbot
bash scripts/install.sh
```

The install script:
- Installs system dependencies (libpq-dev, pkg-config, libssl-dev, etc.)
- Installs Rust toolchain
- Installs Diesel CLI
- Runs database migrations
- Builds and installs the binary
- Sets up systemd service
- Creates `update-tugbot` command symlink

### Updating Production

After pushing changes to the repository:

```bash
# SSH into the LXC (key-based authentication)
ssh root@tugbot

# Run update command
update-tugbot
```

The `update-tugbot` command:
- Pulls latest changes from `origin/main`
- Runs database migrations
- Rebuilds and installs the binary
- Restarts the systemd service

### Service Management

```bash
systemctl status tugbot    # Check status
systemctl restart tugbot   # Restart service
systemctl stop tugbot      # Stop service
systemctl start tugbot     # Start service
journalctl -u tugbot -f    # View logs
```

## Version Bumping and Releases

When asked to bump versions and release:
1. Update version in `Cargo.toml`
2. Run `cargo build` to verify
3. Commit with message format: "bump version to X.Y.Z"
4. Tag the release: `git tag vX.Y.Z`
5. Push with tags: `git push && git push --tags`

## Important Notes

- The bot uses Serenity 0.11.6 with specific feature flags
- Database connection is established per-operation (not pooled in current implementation)
- Discord embeds are suppressed for social media links before posting rewritten versions
- The "gulag" feature uses Discord's timeout/role system, not native Discord timeouts
- Commands are note and phony/horny appear swapped in the interaction handler (intentional)
- When working with time-based queries in gulag system, always handle cases where `release_at` may be in the past (use `.duration_since()` with proper error handling)
